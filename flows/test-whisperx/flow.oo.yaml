title: "%test-whisperx-transcription-with-srt-generation%"
nodes:
  - node_id: whisperx-transcribe#1
    task: self::whisperx-transcribe
    inputs_from:
      - handle: audio_file
        value: /oomol-driver/oomol-storage/kl.mp3
        from_node:
          - node_id: extract-audio#1
            output_handle: audio_file
      - handle: model_size
        value: large-v3
      - handle: language
        value: en
      - handle: batch_size
        value: 16
      - handle: enable_alignment
        value: true
      - handle: enable_diarization
        value: false
      - handle: hf_token
        value: "${{OO_SECRET:HuggingFace,HuggingFace,HF_TOKEN}}"
      - handle: compute_type
        value: "float16"
      - handle: beam_size
        value: 5
      - handle: best_of
        value: 5
      - handle: temperature
        value: 0
      - handle: patience
        value: 1.0
      - handle: length_penalty
        value: 1.0
      - handle: condition_on_previous_text
        value: true
      - handle: initial_prompt
        value:
      - handle: vad_filter
        value: true
      - handle: vad_onset
        value: 0.1
      - handle: vad_offset
        value: 0.1
      - handle: min_speech_duration
        value: 0.1
      - handle: min_silence_duration
        value: 0.1
      - handle: chunk_size
        value: 30

  - node_id: generate-srt#1
    task: self::generate-srt
    inputs_from:
      - handle: json_file
        from_node:
          - node_id: whisperx-transcribe#1
            output_handle: output_file
      - handle: include_speaker
        value:
      - handle: output_path
        value:
      - handle: use_spacy_segmentation
        value:
      - handle: spacy_model
        value:
      - handle: max_chars_per_subtitle
        value:
      - handle: max_duration_per_subtitle
        value:
      - handle: chars_per_second
        value:
      - handle: subtitle_language_preset
        value:
      - handle: max_words_per_subtitle
        value:
  - node_id: extract-audio#1
    title: "从视频中提取音频 #1"
    inputs_from:
      - handle: video_file
        from_node:
          - node_id: +value#1
            output_handle: video_file
      - handle: output_format
        value: mp3
      - handle: audio_quality
        value: 192
      - handle: use_gpu
        value: false
    task: ffmpeg::extract-audio
  - node_id: add-subtitles#1
    title: "添加视频字幕 #1"
    inputs_from:
      - handle: video_file
        from_node:
          - node_id: +value#1
            output_handle: video_file
      - handle: subtitle_file
        from_node:
          - node_id: translate-srt#1
            output_handle: translated_srt_file
      - handle: subtitle_style
        value: default
      - handle: font_name
        value: Arial
      - handle: font_size
        value: 20
      - handle: font_color
        value: "#FFFFFF"
      - handle: outline_color
        value: "#000000"
      - handle: subtitle_position
        value: bottom
      - handle: hard_subtitle
        value: true
      - handle: use_gpu
        value: true
      - handle: subtitle_language
        value:
    task: ffmpeg::add-subtitles
  - node_id: +value#1
    title: "Value #1"
    values:
      - handle: video_file
        json_schema:
          type: string
          ui:widget: file
          ui:options:
            filters:
              - name: Video Files
                extensions:
                  - mp4
                  - avi
                  - mov
                  - mkv
                  - webm
                  - flv
            excludeAll: true
        value: /oomol-driver/oomol-storage/video/bm.mp4
        nullable: false
  - node_id: translate-srt#1
    title: "Translate SRT Subtitles #1"
    inputs_from:
      - handle: srt_file
        from_node:
          - node_id: generate-srt#1
            output_handle: srt_file
      - handle: target_language
        value: Chinese
      - handle: source_language
        value: null
      - handle: batch_size
        value: 10
      - handle: output_path
        value: null
      - handle: llm
        value:
          model: deepseek-chat
          temperature: 0.5
          top_p: 1
          max_tokens: 128000
    task: self::translate-srt
